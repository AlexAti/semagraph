shadow$provide.module$node_modules$$zxing$library$cjs$core$aztec$detector$Detector=function(global,require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});exports.Point=void 0;var ResultPoint_1=require("module$node_modules$$zxing$library$cjs$core$ResultPoint"),AztecDetectorResult_1=require("module$node_modules$$zxing$library$cjs$core$aztec$AztecDetectorResult"),MathUtils_1=require("module$node_modules$$zxing$library$cjs$core$common$detector$MathUtils"),WhiteRectangleDetector_1=
require("module$node_modules$$zxing$library$cjs$core$common$detector$WhiteRectangleDetector"),GenericGF_1=require("module$node_modules$$zxing$library$cjs$core$common$reedsolomon$GenericGF"),ReedSolomonDecoder_1=require("module$node_modules$$zxing$library$cjs$core$common$reedsolomon$ReedSolomonDecoder"),NotFoundException_1=require("module$node_modules$$zxing$library$cjs$core$NotFoundException"),GridSamplerInstance_1=require("module$node_modules$$zxing$library$cjs$core$common$GridSamplerInstance"),
Integer_1=require("module$node_modules$$zxing$library$cjs$core$util$Integer"),Point=function(){function Point(x,y){this.x=x;this.y=y}Point.prototype.toResultPoint=function(){return new ResultPoint_1.default(this.getX(),this.getY())};Point.prototype.getX=function(){return this.x};Point.prototype.getY=function(){return this.y};return Point}();exports.Point=Point;global=function(){function Detector(image){this.EXPECTED_CORNER_BITS=new Int32Array([3808,476,2107,1799]);this.image=image}Detector.prototype.detect=
function(){return this.detectMirror(!1)};Detector.prototype.detectMirror=function(isMirror){var pCenter=this.getMatrixCenter();pCenter=this.getBullsEyeCorners(pCenter);isMirror&&(isMirror=pCenter[0],pCenter[0]=pCenter[2],pCenter[2]=isMirror);this.extractParameters(pCenter);isMirror=this.sampleGrid(this.image,pCenter[this.shift%4],pCenter[(this.shift+1)%4],pCenter[(this.shift+2)%4],pCenter[(this.shift+3)%4]);pCenter=this.getMatrixCornerPoints(pCenter);return new AztecDetectorResult_1.default(isMirror,
pCenter,this.compact,this.nbDataBlocks,this.nbLayers)};Detector.prototype.extractParameters=function(bullsEyeCorners){if(!(this.isValidPoint(bullsEyeCorners[0])&&this.isValidPoint(bullsEyeCorners[1])&&this.isValidPoint(bullsEyeCorners[2])&&this.isValidPoint(bullsEyeCorners[3])))throw new NotFoundException_1.default;var length=2*this.nbCenterLayers;bullsEyeCorners=new Int32Array([this.sampleLine(bullsEyeCorners[0],bullsEyeCorners[1],length),this.sampleLine(bullsEyeCorners[1],bullsEyeCorners[2],length),
this.sampleLine(bullsEyeCorners[2],bullsEyeCorners[3],length),this.sampleLine(bullsEyeCorners[3],bullsEyeCorners[0],length)]);this.shift=this.getRotation(bullsEyeCorners,length);for(var i=length=0;4>i;i++){var side=bullsEyeCorners[(this.shift+i)%4];this.compact?(length<<=7,length+=side>>1&127):(length<<=10,length+=(side>>2&992)+(side>>1&31))}bullsEyeCorners=this.getCorrectedParameterData(length,this.compact);this.compact?(this.nbLayers=(bullsEyeCorners>>6)+1,this.nbDataBlocks=(bullsEyeCorners&63)+
1):(this.nbLayers=(bullsEyeCorners>>11)+1,this.nbDataBlocks=(bullsEyeCorners&2047)+1)};Detector.prototype.getRotation=function(sides,length){var cornerBits=0;sides.forEach(function(side,idx,arr){cornerBits=(cornerBits<<3)+((side>>length-2<<1)+(side&1))});cornerBits=((cornerBits&1)<<11)+(cornerBits>>1);for(sides=0;4>sides;sides++)if(2>=Integer_1.default.bitCount(cornerBits^this.EXPECTED_CORNER_BITS[sides]))return sides;throw new NotFoundException_1.default;};Detector.prototype.getCorrectedParameterData=
function(parameterData,compact){if(compact){var numCodewords=7;compact=2}else numCodewords=10,compact=4;var numECCodewords=numCodewords-compact,parameterWords=new Int32Array(numCodewords);for(--numCodewords;0<=numCodewords;--numCodewords)parameterWords[numCodewords]=parameterData&15,parameterData>>=4;try{(new ReedSolomonDecoder_1.default(GenericGF_1.default.AZTEC_PARAM)).decode(parameterWords,numECCodewords)}catch(ignored){throw new NotFoundException_1.default;}for(numCodewords=parameterData=0;numCodewords<
compact;numCodewords++)parameterData=(parameterData<<4)+parameterWords[numCodewords];return parameterData};Detector.prototype.getBullsEyeCorners=function(pCenter){var pina=pCenter,pinb=pCenter,pinc=pCenter,color=!0;for(this.nbCenterLayers=1;9>this.nbCenterLayers;this.nbCenterLayers++){var pouta=this.getFirstDifferent(pina,color,1,-1),poutb=this.getFirstDifferent(pinb,color,1,1),poutc=this.getFirstDifferent(pinc,color,-1,1),poutd=this.getFirstDifferent(pCenter,color,-1,-1);if(2<this.nbCenterLayers){var q=
this.distancePoint(poutd,pouta)*this.nbCenterLayers/(this.distancePoint(pCenter,pina)*(this.nbCenterLayers+2));if(.75>q||1.25<q||!this.isWhiteOrBlackRectangle(pouta,poutb,poutc,poutd))break}pina=pouta;pinb=poutb;pinc=poutc;pCenter=poutd;color=!color}if(5!==this.nbCenterLayers&&7!==this.nbCenterLayers)throw new NotFoundException_1.default;this.compact=5===this.nbCenterLayers;pina=new ResultPoint_1.default(pina.getX()+.5,pina.getY()-.5);pinb=new ResultPoint_1.default(pinb.getX()+.5,pinb.getY()+.5);
pinc=new ResultPoint_1.default(pinc.getX()-.5,pinc.getY()+.5);pCenter=new ResultPoint_1.default(pCenter.getX()-.5,pCenter.getY()-.5);return this.expandSquare([pina,pinb,pinc,pCenter],2*this.nbCenterLayers-3,2*this.nbCenterLayers)};Detector.prototype.getMatrixCenter=function(){try{var cornerPoints=(new WhiteRectangleDetector_1.default(this.image)).detect();var pointA=cornerPoints[0];var pointB=cornerPoints[1];var pointC=cornerPoints[2];var pointD=cornerPoints[3]}catch(e){pointD=this.image.getWidth()/
2;var cy_1=this.image.getHeight()/2;pointA=this.getFirstDifferent(new Point(pointD+7,cy_1-7),!1,1,-1).toResultPoint();pointB=this.getFirstDifferent(new Point(pointD+7,cy_1+7),!1,1,1).toResultPoint();pointC=this.getFirstDifferent(new Point(pointD-7,cy_1+7),!1,-1,1).toResultPoint();pointD=this.getFirstDifferent(new Point(pointD-7,cy_1-7),!1,-1,-1).toResultPoint()}cy_1=MathUtils_1.default.round((pointA.getX()+pointD.getX()+pointB.getX()+pointC.getX())/4);var cy=MathUtils_1.default.round((pointA.getY()+
pointD.getY()+pointB.getY()+pointC.getY())/4);try{cornerPoints=(new WhiteRectangleDetector_1.default(this.image,15,cy_1,cy)).detect(),pointA=cornerPoints[0],pointB=cornerPoints[1],pointC=cornerPoints[2],pointD=cornerPoints[3]}catch(e){pointA=this.getFirstDifferent(new Point(cy_1+7,cy-7),!1,1,-1).toResultPoint(),pointB=this.getFirstDifferent(new Point(cy_1+7,cy+7),!1,1,1).toResultPoint(),pointC=this.getFirstDifferent(new Point(cy_1-7,cy+7),!1,-1,1).toResultPoint(),pointD=this.getFirstDifferent(new Point(cy_1-
7,cy-7),!1,-1,-1).toResultPoint()}cy_1=MathUtils_1.default.round((pointA.getX()+pointD.getX()+pointB.getX()+pointC.getX())/4);cy=MathUtils_1.default.round((pointA.getY()+pointD.getY()+pointB.getY()+pointC.getY())/4);return new Point(cy_1,cy)};Detector.prototype.getMatrixCornerPoints=function(bullsEyeCorners){return this.expandSquare(bullsEyeCorners,2*this.nbCenterLayers,this.getDimension())};Detector.prototype.sampleGrid=function(image,topLeft,topRight,bottomRight,bottomLeft){var sampler=GridSamplerInstance_1.default.getInstance(),
dimension=this.getDimension(),low=dimension/2-this.nbCenterLayers,high=dimension/2+this.nbCenterLayers;return sampler.sampleGrid(image,dimension,dimension,low,low,high,low,high,high,low,high,topLeft.getX(),topLeft.getY(),topRight.getX(),topRight.getY(),bottomRight.getX(),bottomRight.getY(),bottomLeft.getX(),bottomLeft.getY())};Detector.prototype.sampleLine=function(p1,p2,size){var result=0,d=this.distanceResultPoint(p1,p2),moduleSize=d/size,px=p1.getX(),py=p1.getY(),dx=moduleSize*(p2.getX()-p1.getX())/
d;p1=moduleSize*(p2.getY()-p1.getY())/d;for(p2=0;p2<size;p2++)this.image.get(MathUtils_1.default.round(px+p2*dx),MathUtils_1.default.round(py+p2*p1))&&(result|=1<<size-p2-1);return result};Detector.prototype.isWhiteOrBlackRectangle=function(p1,p2,p3,p4){p1=new Point(p1.getX()-3,p1.getY()+3);p2=new Point(p2.getX()-3,p2.getY()-3);p3=new Point(p3.getX()+3,p3.getY()-3);p4=new Point(p4.getX()+3,p4.getY()+3);var cInit=this.getColor(p4,p1);if(0===cInit)return!1;p1=this.getColor(p1,p2);if(p1!==cInit)return!1;
p1=this.getColor(p2,p3);if(p1!==cInit)return!1;p1=this.getColor(p3,p4);return p1===cInit};Detector.prototype.getColor=function(p1,p2){var d=this.distancePoint(p1,p2),dx=(p2.getX()-p1.getX())/d;p2=(p2.getY()-p1.getY())/d;var error=0,px=p1.getX(),py=p1.getY();p1=this.image.get(p1.getX(),p1.getY());for(var iMax=Math.ceil(d),i=0;i<iMax;i++)px+=dx,py+=p2,this.image.get(MathUtils_1.default.round(px),MathUtils_1.default.round(py))!==p1&&error++;d=error/d;return.1<d&&.9>d?0:.1>=d===p1?1:-1};Detector.prototype.getFirstDifferent=
function(init,color,dx,dy){var x=init.getX()+dx;for(init=init.getY()+dy;this.isValid(x,init)&&this.image.get(x,init)===color;)x+=dx,init+=dy;x-=dx;for(init-=dy;this.isValid(x,init)&&this.image.get(x,init)===color;)x+=dx;for(x-=dx;this.isValid(x,init)&&this.image.get(x,init)===color;)init+=dy;return new Point(x,init-dy)};Detector.prototype.expandSquare=function(cornerPoints,oldSide,newSide){var ratio=newSide/(2*oldSide),dx=cornerPoints[0].getX()-cornerPoints[2].getX(),dy=cornerPoints[0].getY()-cornerPoints[2].getY(),
centerx=(cornerPoints[0].getX()+cornerPoints[2].getX())/2,centery=(cornerPoints[0].getY()+cornerPoints[2].getY())/2;oldSide=new ResultPoint_1.default(centerx+ratio*dx,centery+ratio*dy);newSide=new ResultPoint_1.default(centerx-ratio*dx,centery-ratio*dy);dx=cornerPoints[1].getX()-cornerPoints[3].getX();dy=cornerPoints[1].getY()-cornerPoints[3].getY();centerx=(cornerPoints[1].getX()+cornerPoints[3].getX())/2;centery=(cornerPoints[1].getY()+cornerPoints[3].getY())/2;cornerPoints=new ResultPoint_1.default(centerx+
ratio*dx,centery+ratio*dy);ratio=new ResultPoint_1.default(centerx-ratio*dx,centery-ratio*dy);return[oldSide,cornerPoints,newSide,ratio]};Detector.prototype.isValid=function(x,y){return 0<=x&&x<this.image.getWidth()&&0<y&&y<this.image.getHeight()};Detector.prototype.isValidPoint=function(point){var x=MathUtils_1.default.round(point.getX());point=MathUtils_1.default.round(point.getY());return this.isValid(x,point)};Detector.prototype.distancePoint=function(a,b){return MathUtils_1.default.distance(a.getX(),
a.getY(),b.getX(),b.getY())};Detector.prototype.distanceResultPoint=function(a,b){return MathUtils_1.default.distance(a.getX(),a.getY(),b.getX(),b.getY())};Detector.prototype.getDimension=function(){return this.compact?4*this.nbLayers+11:4>=this.nbLayers?4*this.nbLayers+15:4*this.nbLayers+2*(Integer_1.default.truncDivision(this.nbLayers-4,8)+1)+15};return Detector}();exports.default=global}
//# sourceMappingURL=module$node_modules$$zxing$library$cjs$core$aztec$detector$Detector.js.map
