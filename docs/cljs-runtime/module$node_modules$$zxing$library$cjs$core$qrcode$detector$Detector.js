shadow$provide.module$node_modules$$zxing$library$cjs$core$qrcode$detector$Detector=function(global,require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var MathUtils_1=require("module$node_modules$$zxing$library$cjs$core$common$detector$MathUtils"),DetectorResult_1=require("module$node_modules$$zxing$library$cjs$core$common$DetectorResult"),GridSamplerInstance_1=require("module$node_modules$$zxing$library$cjs$core$common$GridSamplerInstance"),PerspectiveTransform_1=require("module$node_modules$$zxing$library$cjs$core$common$PerspectiveTransform"),
DecodeHintType_1=require("module$node_modules$$zxing$library$cjs$core$DecodeHintType"),NotFoundException_1=require("module$node_modules$$zxing$library$cjs$core$NotFoundException"),ResultPoint_1=require("module$node_modules$$zxing$library$cjs$core$ResultPoint"),Version_1=require("module$node_modules$$zxing$library$cjs$core$qrcode$decoder$Version"),AlignmentPatternFinder_1=require("module$node_modules$$zxing$library$cjs$core$qrcode$detector$AlignmentPatternFinder"),FinderPatternFinder_1=require("module$node_modules$$zxing$library$cjs$core$qrcode$detector$FinderPatternFinder");
global=function(){function Detector(image){this.image=image}Detector.prototype.getImage=function(){return this.image};Detector.prototype.getResultPointCallback=function(){return this.resultPointCallback};Detector.prototype.detect=function(hints){this.resultPointCallback=null===hints||void 0===hints?null:hints.get(DecodeHintType_1.default.NEED_RESULT_POINT_CALLBACK);hints=(new FinderPatternFinder_1.default(this.image,this.resultPointCallback)).find(hints);return this.processFinderPatternInfo(hints)};
Detector.prototype.processFinderPatternInfo=function(info){var topLeft=info.getTopLeft(),topRight=info.getTopRight();info=info.getBottomLeft();var moduleSize=this.calculateModuleSize(topLeft,topRight,info);if(1>moduleSize)throw new NotFoundException_1.default("No pattern found in proccess finder.");var dimension=Detector.computeDimension(topLeft,topRight,info,moduleSize),provisionalVersion=Version_1.default.getProvisionalVersionForDimension(dimension),modulesBetweenFPCenters=provisionalVersion.getDimensionForVersion()-
7,alignmentPattern=null;if(0<provisionalVersion.getAlignmentPatternCenters().length){var bottomRightX=topRight.getX()-topLeft.getX()+info.getX();provisionalVersion=topRight.getY()-topLeft.getY()+info.getY();var correctionToTopLeft=1-3/modulesBetweenFPCenters;modulesBetweenFPCenters=Math.floor(topLeft.getX()+correctionToTopLeft*(bottomRightX-topLeft.getX()));provisionalVersion=Math.floor(topLeft.getY()+correctionToTopLeft*(provisionalVersion-topLeft.getY()));for(bottomRightX=4;16>=bottomRightX;bottomRightX<<=
1)try{alignmentPattern=this.findAlignmentInRegion(moduleSize,modulesBetweenFPCenters,provisionalVersion,bottomRightX);break}catch(re){if(!(re instanceof NotFoundException_1.default))throw re;}}moduleSize=Detector.createTransform(topLeft,topRight,info,alignmentPattern,dimension);dimension=Detector.sampleGrid(this.image,moduleSize,dimension);return new DetectorResult_1.default(dimension,null===alignmentPattern?[info,topLeft,topRight]:[info,topLeft,topRight,alignmentPattern])};Detector.createTransform=
function(topLeft,topRight,bottomLeft,alignmentPattern,dimension){dimension-=3.5;var sourceBottomRightX;if(null!==alignmentPattern){var bottomRightX=alignmentPattern.getX();alignmentPattern=alignmentPattern.getY();var sourceBottomRightY=sourceBottomRightX=dimension-3}else bottomRightX=topRight.getX()-topLeft.getX()+bottomLeft.getX(),alignmentPattern=topRight.getY()-topLeft.getY()+bottomLeft.getY(),sourceBottomRightY=sourceBottomRightX=dimension;return PerspectiveTransform_1.default.quadrilateralToQuadrilateral(3.5,
3.5,dimension,3.5,sourceBottomRightX,sourceBottomRightY,3.5,dimension,topLeft.getX(),topLeft.getY(),topRight.getX(),topRight.getY(),bottomRightX,alignmentPattern,bottomLeft.getX(),bottomLeft.getY())};Detector.sampleGrid=function(image,transform,dimension){return GridSamplerInstance_1.default.getInstance().sampleGridWithTransform(image,dimension,dimension,transform)};Detector.computeDimension=function(topLeft,topRight,bottomLeft,moduleSize){topRight=MathUtils_1.default.round(ResultPoint_1.default.distance(topLeft,
topRight)/moduleSize);topLeft=MathUtils_1.default.round(ResultPoint_1.default.distance(topLeft,bottomLeft)/moduleSize);topLeft=Math.floor((topRight+topLeft)/2)+7;switch(topLeft&3){case 0:topLeft++;break;case 2:topLeft--;break;case 3:throw new NotFoundException_1.default("Dimensions could be not found.");}return topLeft};Detector.prototype.calculateModuleSize=function(topLeft,topRight,bottomLeft){return(this.calculateModuleSizeOneWay(topLeft,topRight)+this.calculateModuleSizeOneWay(topLeft,bottomLeft))/
2};Detector.prototype.calculateModuleSizeOneWay=function(pattern,otherPattern){var moduleSizeEst1=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(pattern.getX()),Math.floor(pattern.getY()),Math.floor(otherPattern.getX()),Math.floor(otherPattern.getY()));pattern=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(otherPattern.getX()),Math.floor(otherPattern.getY()),Math.floor(pattern.getX()),Math.floor(pattern.getY()));return isNaN(moduleSizeEst1)?pattern/7:isNaN(pattern)?moduleSizeEst1/7:(moduleSizeEst1+
pattern)/14};Detector.prototype.sizeOfBlackWhiteBlackRunBothWays=function(fromX,fromY,toX,toY){var result=this.sizeOfBlackWhiteBlackRun(fromX,fromY,toX,toY),scale=1;toX=fromX-(toX-fromX);0>toX?(scale=fromX/(fromX-toX),toX=0):toX>=this.image.getWidth()&&(scale=(this.image.getWidth()-1-fromX)/(toX-fromX),toX=this.image.getWidth()-1);toY=Math.floor(fromY-(toY-fromY)*scale);scale=1;0>toY?(scale=fromY/(fromY-toY),toY=0):toY>=this.image.getHeight()&&(scale=(this.image.getHeight()-1-fromY)/(toY-fromY),toY=
this.image.getHeight()-1);toX=Math.floor(fromX+(toX-fromX)*scale);result+=this.sizeOfBlackWhiteBlackRun(fromX,fromY,toX,toY);return result-1};Detector.prototype.sizeOfBlackWhiteBlackRun=function(fromX,fromY,toX,toY){var steep=Math.abs(toY-fromY)>Math.abs(toX-fromX);if(steep){var temp=fromX;fromX=fromY;fromY=temp;temp=toX;toX=toY;toY=temp}temp=Math.abs(toX-fromX);for(var dy=Math.abs(toY-fromY),error=-temp/2,xstep=fromX<toX?1:-1,ystep=fromY<toY?1:-1,state=0,xLimit=toX+xstep,x=fromX,y=fromY;x!==xLimit;x+=
xstep){if(1===state===this.image.get(steep?y:x,steep?x:y)){if(2===state)return MathUtils_1.default.distance(x,y,fromX,fromY);state++}error+=dy;if(0<error){if(y===toY)break;y+=ystep;error-=temp}}return 2===state?MathUtils_1.default.distance(toX+xstep,toY,fromX,fromY):NaN};Detector.prototype.findAlignmentInRegion=function(overallEstModuleSize,estAlignmentX,estAlignmentY,allowanceFactor){var allowance=Math.floor(allowanceFactor*overallEstModuleSize);allowanceFactor=Math.max(0,estAlignmentX-allowance);
estAlignmentX=Math.min(this.image.getWidth()-1,estAlignmentX+allowance);if(estAlignmentX-allowanceFactor<3*overallEstModuleSize)throw new NotFoundException_1.default("Alignment top exceeds estimated module size.");var alignmentAreaTopY=Math.max(0,estAlignmentY-allowance);estAlignmentY=Math.min(this.image.getHeight()-1,estAlignmentY+allowance);if(estAlignmentY-alignmentAreaTopY<3*overallEstModuleSize)throw new NotFoundException_1.default("Alignment bottom exceeds estimated module size.");return(new AlignmentPatternFinder_1.default(this.image,
allowanceFactor,alignmentAreaTopY,estAlignmentX-allowanceFactor,estAlignmentY-alignmentAreaTopY,overallEstModuleSize,this.resultPointCallback)).find()};return Detector}();exports.default=global}
//# sourceMappingURL=module$node_modules$$zxing$library$cjs$core$qrcode$detector$Detector.js.map
